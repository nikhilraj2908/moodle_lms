{"version":3,"file":"translation_button.min.js","sources":["../src/translation_button.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package filter_translations\n * @author Andrew Hancox <andrewdchancox@googlemail.com>\n * @author Open Source Learning <enquiries@opensourcelearning.co.uk>\n * @link https://opensourcelearning.co.uk\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @copyright 2021, Andrew Hancox\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/str', 'core/templates'], function ($, ModalFactory, Str, templates) {\n    var translation_button = {\n        'returnurl': '',\n        'init': function (returnurl) {\n            translation_button.returnurl = returnurl;\n            // Register both right and left click handlers on the translation button - we need both as it will sometimes\n            // conflict with the left click action on elements in front.\n            $('body').on('click', '.filter_translations_btn_translate', translation_button.opentranslation);\n            $('body').on('contextmenu', '.filter_translations_btn_translate', translation_button.opentranslation);\n        },\n        'findandinjectbuttons': function() {\n            var encodedone = \"\\u{200B}\"; // Zero-Width Space\n            var encodedzero = \"\\u{200C}\"; // Zero-Width Non-Joiner\n            var encodedseperator = \"\\u{200D}\"; // Zero-Width Joiner\n\n            // Two encodedseperator next to each other indicates a placeholder to swap for a translation button.\n            var elems = translation_button.findElementsDirectlyContainingText(document, encodedseperator + encodedseperator);\n            let itemsprocessed = 0;\n            let missingitems = [];\n            elems.forEach(function(elem) {\n                var matches = new RegExp(encodedseperator + encodedseperator + '([' + encodedone + encodedzero + ']*)');\n\n                var regexzero = new RegExp(encodedzero, 'g');\n                var regexone = new RegExp(encodedone, 'g');\n\n                // Decode the inpagetranslationid so we can grab the translation info from translation_button.objects.\n                var binary = matches.exec($(elem).html())[1].replace(regexone, '1').replace(regexzero, '0');\n                var key = parseInt(binary, 2);\n                var translationinfo = translation_button.objects[key];\n\n                // Render the translation button.\n                templates.render('filter_translations/translatebutton', translationinfo).done(function (html) {\n                    $(elem).append(html);\n\n                    // Some content may be rendered multiple times, such as in title attributes, for screenreaders\n                    // and hidden for display in responsive views.\n                    // Do not count duplicates.\n                    if (translationinfo.notranslation == true) {\n                        if (!missingitems.includes(translationinfo.generatedhash)) {\n                            missingitems.push(translationinfo.generatedhash);\n                        }\n                    }\n\n                    itemsprocessed++;\n                    if (itemsprocessed === elems.length) {\n                        // Last inline button has been added. Now we can start counting.\n                        // There will always be one <title> element, but get its count anyways.\n                        const titlemissing = document.querySelectorAll('title .icon-translate-cross').length;\n                        const missingitemscount = missingitems.length - titlemissing;\n\n                        // Count missing and stale translations and inject the numbers into the menu.\n                        // This has to be done in JS as we need to render the menu in the header but don't know the number\n                        // until the whole page has renderred.\n                        let stalecount = 0;\n                        for (let k in translation_button.objects) {\n                            if (translation_button.objects[k].staletranslation) {\n                                stalecount += 1;\n                            }\n                        }\n\n                        const totalcount = stalecount + missingitemscount;\n\n                        $('.translation-icon-wrapper i').after(\n                            '<div class=\"count-container \" data-region=\"count-container\">'\n                            + translation_button.cap_count(totalcount)\n                            + '</div>'\n                        );\n\n                        $('.translation-icon-wrapper a.missingonthispage').html(\n                            $('.translation-icon-wrapper a.missingonthispage').html()\n                            + ' (' +  translation_button.cap_count(missingitemscount) + ')'\n                        );\n\n                        $('.translation-icon-wrapper a.staleonthispage').html(\n                            $('.translation-icon-wrapper a.staleonthispage').html()\n                            + ' (' +  translation_button.cap_count(stalecount) + ')'\n                        );\n                    }\n                });\n            });\n        },\n        'opentranslation': function (event) {\n            event.stopPropagation();\n            event.preventDefault();\n\n            var context = translation_button.objects[$(this).data('inpagetranslationid')];\n            context.returnurl = translation_button.returnurl;\n\n            // Show the translation modal.\n            Str.get_strings([{\n                key: 'translationdetails',\n                component: 'filter_translations'\n            }]).then(function (langStrings) {\n                return templates.render('filter_translations/translationdetailsmodalbody', context).done(function (html) {\n                    ModalFactory.create({\n                        title: langStrings[0],\n                        body: html,\n                        type: ModalFactory.types.ALERT\n                    }).then(function (modal) {\n                        modal.show();\n                    });\n                });\n            }).fail(Notification.exception);\n        },\n        'register': function (key, translationinfo) {\n            translation_button.objects[key] = translationinfo;\n        },\n        // Utility function to find elements that contain a piece of text directly, rather than in a descendant.\n        'findElementsDirectlyContainingText': function (ancestor, text) {\n            var elements = [];\n            walk(ancestor);\n            return elements;\n\n            function walk(element) {\n                var n = element.childNodes.length;\n                for (var i = 0; i < n; i++) {\n                    var child = element.childNodes[i];\n                    if (child.nodeType === 3 && child.data.indexOf(text) !== -1) {\n                        elements.push(element);\n                        break;\n                    }\n                }\n                for (var i = 0; i < n; i++) {\n                    var child = element.childNodes[i];\n                    if (child.nodeType === 1) {\n                        walk(child);\n                    }\n                }\n            }\n        },\n        'cap_count': function (count) {\n            if (count < 100) {\n                return count;\n            } else {\n                return '99+';\n            }\n        },\n        objects: {}\n    };\n\n    return translation_button;\n});\n"],"names":["define","$","ModalFactory","Str","templates","translation_button","returnurl","on","opentranslation","elems","findElementsDirectlyContainingText","document","encodedseperator","itemsprocessed","missingitems","forEach","elem","matches","RegExp","regexzero","regexone","binary","exec","html","replace","key","parseInt","translationinfo","objects","render","done","append","notranslation","includes","generatedhash","push","length","titlemissing","querySelectorAll","missingitemscount","stalecount","k","staletranslation","totalcount","after","cap_count","event","stopPropagation","preventDefault","context","this","data","get_strings","component","then","langStrings","create","title","body","type","types","ALERT","modal","show","fail","Notification","exception","ancestor","text","elements","walk","element","n","childNodes","i","child","nodeType","indexOf","count"],"mappings":";;;;;;;;AAwBAA,gDAAO,CAAC,SAAU,qBAAsB,WAAY,mBAAmB,SAAUC,EAAGC,aAAcC,IAAKC,eAC/FC,mBAAqB,WACR,QACL,SAAUC,WACdD,mBAAmBC,UAAYA,UAG/BL,EAAE,QAAQM,GAAG,QAAS,qCAAsCF,mBAAmBG,iBAC/EP,EAAE,QAAQM,GAAG,cAAe,qCAAsCF,mBAAmBG,uCAEjE,eAMhBC,MAAQJ,mBAAmBK,mCAAmCC,SAAUC,UACxEC,eAAiB,EACjBC,aAAe,GACnBL,MAAMM,SAAQ,SAASC,UACfC,QAAU,IAAIC,OAAON,aAErBO,UAAY,IAAID,OAVN,IAU0B,KACpCE,SAAW,IAAIF,OAZN,IAYyB,KAGlCG,OAASJ,QAAQK,KAAKrB,EAAEe,MAAMO,QAAQ,GAAGC,QAAQJ,SAAU,KAAKI,QAAQL,UAAW,KACnFM,IAAMC,SAASL,OAAQ,GACvBM,gBAAkBtB,mBAAmBuB,QAAQH,KAGjDrB,UAAUyB,OAAO,sCAAuCF,iBAAiBG,MAAK,SAAUP,SACpFtB,EAAEe,MAAMe,OAAOR,MAKsB,GAAjCI,gBAAgBK,gBACXlB,aAAamB,SAASN,gBAAgBO,gBACvCpB,aAAaqB,KAAKR,gBAAgBO,gBAI1CrB,iBACIA,iBAAmBJ,MAAM2B,OAAQ,OAG3BC,aAAe1B,SAAS2B,iBAAiB,+BAA+BF,OACxEG,kBAAoBzB,aAAasB,OAASC,iBAK5CG,WAAa,MACZ,IAAIC,KAAKpC,mBAAmBuB,QACzBvB,mBAAmBuB,QAAQa,GAAGC,mBAC9BF,YAAc,SAIhBG,WAAaH,WAAaD,kBAEhCtC,EAAE,+BAA+B2C,MAC7B,+DACEvC,mBAAmBwC,UAAUF,YAC7B,UAGN1C,EAAE,iDAAiDsB,KAC/CtB,EAAE,iDAAiDsB,OACjD,KAAQlB,mBAAmBwC,UAAUN,mBAAqB,KAGhEtC,EAAE,+CAA+CsB,KAC7CtB,EAAE,+CAA+CsB,OAC/C,KAAQlB,mBAAmBwC,UAAUL,YAAc,6BAMtD,SAAUM,OACzBA,MAAMC,kBACND,MAAME,qBAEFC,QAAU5C,mBAAmBuB,QAAQ3B,EAAEiD,MAAMC,KAAK,wBACtDF,QAAQ3C,UAAYD,mBAAmBC,UAGvCH,IAAIiD,YAAY,CAAC,CACb3B,IAAK,qBACL4B,UAAW,yBACXC,MAAK,SAAUC,oBACRnD,UAAUyB,OAAO,kDAAmDoB,SAASnB,MAAK,SAAUP,MAC/FrB,aAAasD,OAAO,CAChBC,MAAOF,YAAY,GACnBG,KAAMnC,KACNoC,KAAMzD,aAAa0D,MAAMC,QAC1BP,MAAK,SAAUQ,OACdA,MAAMC,gBAGfC,KAAKC,aAAaC,qBAEb,SAAUzC,IAAKE,iBACvBtB,mBAAmBuB,QAAQH,KAAOE,oDAGA,SAAUwC,SAAUC,UAClDC,SAAW,mBAINC,KAAKC,iBACNC,EAAID,QAAQE,WAAWrC,OAClBsC,EAAI,EAAGA,EAAIF,EAAGE,IAAK,IAED,KADnBC,MAAQJ,QAAQE,WAAWC,IACrBE,WAAgD,IAA9BD,MAAMxB,KAAK0B,QAAQT,MAAc,CACzDC,SAASlC,KAAKoC,oBAIbG,EAAI,EAAGA,EAAIF,EAAGE,IAAK,KACpBC,MACmB,KADnBA,MAAQJ,QAAQE,WAAWC,IACrBE,UACNN,KAAKK,QAfjBL,CAAKH,UACEE,oBAmBE,SAAUS,cACfA,MAAQ,IACDA,MAEA,OAGflD,QAAS,WAGNvB"}